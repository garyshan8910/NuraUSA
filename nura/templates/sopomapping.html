{% extends "base.html" %}

{% block content %}
<div class="container justify-content-center">
    <div class="row">
        <div class="col">
            <div id="soitemTB">
                <div class="search" style="display: none;">
                    <form class="search-form">
                        <div class="row g-2">
                        </div>
                    </form>
                    <button type="button" class="btn-sm btn-primary search-btn">search</button>
                    <button type="button" class="btn-sm btn-info reset-btn">reset</button>
                </div>
                <table class="table table-striped table-sm">
                    <thead></thead>
                    <tbody></tbody>
                </table>
                <nav class="pager" aria-label="Page navigation" style="display: none">
                    <ul class="pagination justify-content-center">
                        <li class="page-item"><a class="page-link">total <span class="total-items"></span>
                                items</a></li>
                        <li class="page-item">
                            <a class="page-link pre-page" href="#" aria-label="Previous">
                                <span aria-hidden="true">&laquo;</span>
                                <span class="sr-only"></span>
                            </a>
                        </li>
                        <li class="page-item">
                            <input class="form-control page-num" type="text" style="width: 65px; text-align: center;"
                                value="1">
                        </li>
                        <li class="page-item"><a class="page-link" href="#">/ <span class="total-page">100</span></a>
                        </li>
                        <li class="page-item"><a class="page-link goto-page" href="#">Go</a></li>
                        <li class="page-item">
                            <a class="page-link next-page" href="#" aria-label="Next">
                                <span aria-hidden="true">&raquo;</span>
                                <span class="sr-only"></span>
                            </a>
                        </li>
                        <input type="hidden" class="params" />
                    </ul>
                </nav>
            </div>
        </div>
        <div class="col">
            <div id="allocate-alert">
                <div class="alert" role="alert" style="display:block; ">
                    <div class="message" style="color: #fff;"></div>
                </div>
            </div>
            <div id="inventoryTB">
                <div class="search" style="display: none;">
                    <form class="search-form">
                        <div class="row g-2">
                        </div>
                    </form>
                    <button type="button" class="btn-sm btn-primary search-btn">search</button>
                    <button type="button" class="btn-sm btn-info reset-btn">reset</button>
                </div>
                <table class="table table-striped table-sm">
                    <thead></thead>
                    <tbody></tbody>
                </table>
                <nav class="pager" aria-label="Page navigation" style="display: none">
                    <ul class="pagination justify-content-center">
                        <li class="page-item"><a class="page-link">total <span class="total-items"></span>
                                items</a></li>
                        <li class="page-item">
                            <a class="page-link pre-page" href="#" aria-label="Previous">
                                <span aria-hidden="true">&laquo;</span>
                                <span class="sr-only"></span>
                            </a>
                        </li>
                        <li class="page-item">
                            <input class="form-control page-num" type="text" style="width: 65px; text-align: center;"
                                value="1">
                        </li>
                        <li class="page-item"><a class="page-link" href="#">/ <span class="total-page">100</span></a>
                        </li>
                        <li class="page-item"><a class="page-link goto-page" href="#">Go</a></li>
                        <li class="page-item">
                            <a class="page-link next-page" href="#" aria-label="Next">
                                <span aria-hidden="true">&raquo;</span>
                                <span class="sr-only"></span>
                            </a>
                        </li>
                        <input type="hidden" class="params" />
                    </ul>
                </nav>
            </div>
            <div id="poitemTB">
                <div class="search" style="display: none;">
                    <form class="search-form">
                        <div class="row g-2">
                        </div>
                    </form>
                    <button type="button" class="btn-sm btn-primary search-btn">search</button>
                    <button type="button" class="btn-sm btn-info reset-btn">reset</button>
                </div>
                <table class="table table-striped table-sm">
                    <thead></thead>
                    <tbody></tbody>
                </table>
                <nav class="pager" aria-label="Page navigation" style="display: none">
                    <ul class="pagination justify-content-center">
                        <li class="page-item"><a class="page-link">total <span class="total-items"></span>
                                items</a></li>
                        <li class="page-item">
                            <a class="page-link pre-page" href="#" aria-label="Previous">
                                <span aria-hidden="true">&laquo;</span>
                                <span class="sr-only"></span>
                            </a>
                        </li>
                        <li class="page-item">
                            <input class="form-control page-num" type="text" style="width: 65px; text-align: center;"
                                value="1">
                        </li>
                        <li class="page-item"><a class="page-link" href="#">/ <span class="total-page">100</span></a>
                        </li>
                        <li class="page-item"><a class="page-link goto-page" href="#">Go</a></li>
                        <li class="page-item">
                            <a class="page-link next-page" href="#" aria-label="Next">
                                <span aria-hidden="true">&raquo;</span>
                                <span class="sr-only"></span>
                            </a>
                        </li>
                        <input type="hidden" class="params" />
                    </ul>
                </nav>
            </div>
        </div>
    </div>
</div>
{% endblock %}
{% block scripts %}
<script type="text/javascript" charset="utf8" src="../static/dt.js"></script>
<script>
    class accordionTB extends TB {
        constructor(settings) {
            $.extend(settings, { has_fixed_html: false })
            super(settings)
            this.genHtml()
        }
        fetchData(callback) {
            // console.log("fetchData", arguments)
            var args = Array.from(arguments).slice(1)
            return $.getJSON(this.url, this.params)
                .then($.proxy(this, "updateData"))
                .then($.proxy(this, callback.name, ...args))
                .fail(function (jqxhr, textStatus, error) {
                    console.log("jqxhr", jqxhr)
                    console.log("textStatus", textStatus)
                    console.log("error", error)
                })
        }
        genHtml() {
            this.fetchData(this.renderTableByRowId, this.rowId)
        }
        renderTableByRowId(rowId) {
            // console.log("renderTableByRowId",arguments)
            // console.log("renderTableByRowId",rowId)
            var sum_row = this.addSumUpRow("qty")

            $(`#${rowId}`).find("table").html(
                `<tbody>
                ${this.tbodyHtml(this.data)}
                ${sum_row}
                </tbody>`)
        }
        addSumUpRow(targetCol) {
            var total = 0
            $.each(this.data, function () {
                total += parseFloat(this[targetCol])
            })
            var html = '<tr><td></td>'
            for (const i in this.visible) {
                var colName = this.visible[i]
                if (colName == targetCol) {
                    html += `<td>${total.toFixed(2)}</td>`
                } else {
                    html += '<td></td>'
                }
            }
            html += '</tr>'
            return total > 0 ? html : ""
        }
    }

    class SOITEMTB extends TB {
        constructor(settings) {
            super(settings)
            this.bindRowClickEvent()
            this.setRowClickable(false)
            this.bindPageClickEvent()
        }
        bindPageClickEvent() {
            this.pager.on('click', $.proxy(function () {
                this.inventoryTB.clearTable()
                this.poitemTB.clearTable()
            }, this))
        }
        setRowClickable(can_unselect_row) {
            this.table.on('click', 'tr.clickable-row', function () {
                if (can_unselect_row) {
                    if ($(this).hasClass('table-primary')) {
                        $(this).removeClass('table-primary')
                    }
                    else {
                        $(this).addClass('table-primary').siblings().removeClass('table-primary');
                    }
                } else {
                    $(this).addClass('table-primary').siblings().removeClass('table-primary');
                }
            })
        }

        bindRowClickEvent() {
            var inventory_tb = this.inventoryTB
            var poitem_tb = this.poitemTB
            var soitem_tb = this
            this.table.on('click', '.clickable-row', function (e) {
                var partId = $(this).closest('tr').find('.partid').val()
                var soitemid = $(this).closest('tr').find('.soitemid').val()
                $.extend(inventory_tb.params, { "partId": partId })
                $.extend(poitem_tb.params, { "partId": partId })
                inventory_tb.soitemid = soitemid
                poitem_tb.soitemid = soitemid
                inventory_tb.refresh()
                poitem_tb.refresh()
            })
            this.table.on('click', '.accordion-button', function (e) {
                e.stopPropagation();
                if ($(this).attr('class').indexOf("collapsed") == -1) {
                    // accordion is not displayed
                    var soitemid = $(this).closest('tr').find('.soitemid').val()
                    var rowId = $(this).attr("data-bs-target").replace("#", "")
                    // console.log("accordion clicked, so_itemid:", so_itemid)
                    soitem_tb.creteAccordinonTB(soitemid, rowId)
                }
            })
        }
        creteAccordinonTB(soitemid, rowId) {
            var accordionTb = new accordionTB({
                url: "/get_soitem_map",
                params: { "so_itemid": soitemid },
                visible: ["", "", "", "ponum", "qty", "created"],
                rowId: rowId
            })
        }
        refreshAccordion(soitemid) {
            var soItemRow = this.table.find(`input[value=${soitemid}]`).closest("tr")
            var accordionBtn = soItemRow.find('button.accordion-button')
            var rowId = accordionBtn.attr("data-bs-target").replace("#", "")
            this.creteAccordinonTB(soitemid, rowId)
            if (accordionBtn.attr('class').indexOf("collapsed") != -1) {
                accordionBtn.trigger('click')
            }
        }
    }

    class INVENTORYTB extends TB {
        constructor(settings) {
            super(settings)
            this.soitemid = 0
            this.params = { "partId": 0 }
            this.post_params = {
                "qty": null,
                "so_item_id": null,
                "allocate_type_id": 0
            }
            this.post_url = ""
            this.soitemTB = null
            $.extend(this, settings)
            this.bindRowClickEvent()
        }
        bindRowClickEvent() {
            var inentoryTB = this
            this.table.on('click', '.allocate_inventory', function () {
                var soitemTB = inentoryTB.soitemTB
                var qty = parseFloat($(this).closest('tr').find('.allocate_input').val())
                if (qty && qty > 0) {
                    inentoryTB.post_params["qty"] = qty
                    inentoryTB.post_params["so_item_id"] = inentoryTB.soitemid
                    $.post(inentoryTB.post_url, inentoryTB.post_params, function (data) {
                        console.log(data)
                        // refresh and show according
                        if (data.success) {
                            soitemTB.refreshAccordion(inentoryTB.soitemid)
                            // show alert message
                        }
                    })
                } else {
                    confirm('allocate input must be positive number')
                }

            })
        }
    }

    class POITEMTB extends TB {
        constructor(settings) {
            super(settings)
            this.soitemid = 0
            this.params = { "partId": 0 }
            this.post_params = {
                "qty": null,
                "so_item_id": null,
                "po_item_id": null,
                "allocate_type_id": 1
            }
            this.post_url = ""
            this.soitemTB = null
            $.extend(this, settings)
            this.bindRowClickEvent()
        }
        bindRowClickEvent() {
            var poitemTB = this
            this.table.on('click', '.allocate_po_item', function () {
                var soitemTB = poitemTB.soitemTB
                var qty = parseFloat($(this).closest('tr').find('.allocate_input').val())
                if (qty && qty > 0) {
                    var poitemid = $(this).closest('tr').find('.poitemid').val()
                    poitemTB.post_params["qty"] = qty
                    poitemTB.post_params["so_item_id"] = poitemTB.soitemid
                    poitemTB.post_params["po_item_id"] = poitemid
                    $.post(poitemTB.post_url, poitemTB.post_params)
                        .done(function (data) {
                            // console.log(data)
                            // refresh and show according
                            if (data.success) {
                                soitemTB.refreshAccordion(poitemTB.soitemid)
                                // show alert message
                                poitemTB.messageBox.showMessage(data.message, "success")
                            }
                        }).fail(function (jqxhr, textStatus, error) {
                            console.log("jqxhr", jqxhr)
                            console.log("textStatus", textStatus)
                            console.log("error", error)
                            poitemTB.messageBox.showMessage(error, "danger")

                        })
                } else {
                    confirm('allocate input must be positive number')
                }
            })
        }
    }

    $(function () {
        var uid_generator = new Generator()

        var messageBox = new MessageBox({
            id: "allocate-alert"
        })

        var inventoryTB = new INVENTORYTB({
            id: "inventoryTB",
            url: "/get_inventory",
            post_url: "/create_soitem_poitem_map_record",
            visible: ["qtyonhand", "qtyonorder", "qtyallocated", "extra"],
            hidden: [],
            extra_col_elems: [{ "tagName": "input", "classname": "allocate_input", "text": "" }, { "tagName": "button", "classname": "allocate_inventory", "text": "allocate" }],
            limit: 1,
            refresh_when_created: false,
            messageBox: messageBox
        })

        var poitemTB = new POITEMTB({
            id: "poitemTB",
            url: "/get_po_items",
            post_url: "/create_soitem_poitem_map_record",
            visible: ["ponum", "qtytofulfill", "qtyfulfilled", "status"],
            hidden: ["poitemid"],
            extra_col_elems: [{ "tagName": "input", "classname": "allocate_input", "text": "" }, { "tagName": "button", "classname": "allocate_po_item", "text": "allocate" }],
            po_items_limit: 5,
            refresh_when_created: false,
            messageBox: messageBox
        })

        var soitemTB = new SOITEMTB({
            id: "soitemTB",
            url: "/get_so_items",
            visible: ["partnum", "productnum", "description", "qtyordered", "sonum"],
            hidden: ["partid", "soitemid"],
            searchable: ["partnum", "sonum", "description"],
            searchable_type: {},
            extra_row_elems: `<input type="hidden" class="mapping-records" />`,
            inventoryTB: inventoryTB,
            poitemTB: poitemTB
        })
        inventoryTB.soitemTB = soitemTB
        poitemTB.soitemTB = soitemTB
    });
</script>
{% endblock %}