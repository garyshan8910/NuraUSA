{% extends "base.html" %}
{% block head %} {% endblock %}

{% block content %}
<div class="container justify-content-center">
    <div id="tb1">
        <div class="search">
            <form>
                <div class="row g-1">
                    <div class="col">
                        <input type="text" class="form-control" placeholder="First name" aria-label="First name">
                    </div>
                </div>
            </form>
        </div>
        <table class="table table-striped table-sm">
            <thead></thead>
            <tbody></tbody>
        </table>
        <nav class="pager" aria-label="Page navigation" style="display: none">
            <ul class="pagination justify-content-center">
                <li class="page-item"><a class="page-link">total <span class="total-items"></span>
                        items</a></li>
                <li class="page-item">
                    <a class="page-link pre-page" href="#" aria-label="Previous">
                        <span aria-hidden="true">&laquo;</span>
                        <span class="sr-only"></span>
                    </a>
                </li>
                <li class="page-item">
                    <input class="form-control page-num" type="text" style="width: 65px; text-align: center;" value="1">
                </li>
                <li class="page-item"><a class="page-link" href="#">/ <span class="total-page">100</span></a></li>
                <li class="page-item"><a class="page-link goto-page" href="#">Go</a></li>
                <li class="page-item">
                    <a class="page-link next-page" href="#" aria-label="Next">
                        <span aria-hidden="true">&raquo;</span>
                        <span class="sr-only"></span>
                    </a>
                </li>
                <input type="hidden" class="params" />
            </ul>
        </nav>
    </div>

    <div id="editModal" class="modal" tabindex="-1" aria-labelledby="modalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Modal title</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form class="edit-form"></form>
                    <div class="hidden-field"></div>
                </div>
                <div class="modal-footer">
                    <div class="message alert" role="alert"></div>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-primary save-form">Save changes</button>
                </div>
            </div>
        </div>
    </div>

    <div id="detailModal" class="modal" tabindex="-1" aria-labelledby="detailModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Details</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div id="dmtb">
                        <table class="table table-striped table-sm">
                            <thead></thead>
                            <tbody></tbody>
                        </table>
                        <nav class="pager" aria-label="Page navigation" style="display: none">
                            <ul class="pagination justify-content-center">
                                <li class="page-item"><a class="page-link">total <span class="total-items"></span>
                                        items</a></li>
                                <li class="page-item">
                                    <a class="page-link pre-page" href="#" aria-label="Previous">
                                        <span aria-hidden="true">&laquo;</span>
                                        <span class="sr-only"></span>
                                    </a>
                                </li>
                                <li class="page-item">
                                    <input class="form-control page-num" type="text"
                                        style="width: 65px; text-align: center;" value="1">
                                </li>
                                <li class="page-item"><a class="page-link" href="#">/ <span
                                            class="total-page">100</span></a></li>
                                <li class="page-item"><a class="page-link goto-page" href="#">Go</a></li>
                                <li class="page-item">
                                    <a class="page-link next-page" href="#" aria-label="Next">
                                        <span aria-hidden="true">&raquo;</span>
                                        <span class="sr-only"></span>
                                    </a>
                                </li>
                                <input type="hidden" class="params" />
                            </ul>
                        </nav>
                    </div>

                    <form class="row">
                        <div class="col-auto">
                            <textarea name="content" placeholder="content" class="form-control content"
                                rows="3"></textarea>
                        </div>
                        <div class="col-auto">
                            <div class="alert" role="alert"></div>
                            <button type="button" class="btn btn-primary mb-3 add-detail">add new detail</button>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <!-- <button type="button" class="btn btn-primary" id="detail_modal_change_btn">Save changes</button> -->
                </div>
            </div>
        </div>
    </div>
</div>

{% endblock %}
{% block scripts %}
<script>
    function Generator() { };
    Generator.prototype.rand = Math.floor(Math.random() * 26) + Date.now();
    Generator.prototype.getId = function () {
        return this.rand++;
    };
    var uid_generator = new Generator()

    var tb = {
        init: function (settings) {
            this.config = {
                id: "",
                url: "",
                visible_col: [],
                hidden_col: [],
                search_dim: [],
                limit: 10,
                extra_col_elems: [],
                params: {}
            };
            $.extend(tb.config, settings);
            tb.setup();
            return tb
        },
        setup: function () {
            // DOM 
            tb.table = $(`#${tb.config.id} table`).eq(0)
            tb.pager = $(`#${tb.config.id} nav.pager`).eq(0)
            tb.prePage = tb.pager.find('a.pre-page').eq(0)
            tb.nextPage = tb.pager.find('a.next-page').eq(0)
            tb.totalPage = tb.pager.find('span.total-page').eq(0)
            tb.gotoPage = tb.pager.find('a.goto-page').eq(0)
            tb.totalItems = tb.pager.find('span.total-items').eq(0)
            tb.pageNum = tb.pager.find('input.page-num').eq(0)
            tb.extra_col_elems_html = tb.get_extra_col_elems_html()
            // variable
            tb.total_page = 0
            tb.data = null
            tb.total = 0
            tb.curr_page = 1

            $.each([tb.prePage, tb.nextPage, tb.gotoPage], function () { $(this).click(tb.changePage) })
            $.each(tb.config.extra_col_elems, tb.bind_button_event)

            tb.fetchData(tb.renderTable)
        },
        getParams: function () {
            return {}
        },
        fetchData: function (callback) {
            params = { "limit": tb.config.limit, "page_num": tb.curr_page }
            console.log("this.getParams()", this.config.params)
            $.extend(params, this.config.params);
            $.getJSON(tb.config.url, params)
                .done(callback)
                .fail(function (jqxhr, textStatus, error) { })
        },
        renderTable: function (data) {
            /*
            input:
            - data: {
                data: list of row record,
                total: total number of record in database for this query
                curr_page: current page number for the data
            }
            */

            // update tb variable where receive new data from server
            tb.data = data.data
            tb.total = data.total
            tb.curr_page = data.curr_page
            tb.total_page = parseInt((tb.total - 1) / tb.config.limit) + 1

            tb.clear_table()
            tb.table.find("thead").html(tb.thead_html(data.data[0], tb.visible))
            tb.table.find("tbody").html(tb.tbody_html(data.data))

            tb.renderPager()
        },
        clear_table: function () {
            $(`#${tb.config.id} table thead`).html("")
            $(`#${tb.config.id} table tbody`).html("")
        },
        thead_html: function (obj) {
            visible = tb.config.visible_col
            if (!obj || Object.keys(obj).length == 0) return "";
            result = "<tr><th>#</th>"
            if (visible.length == 0) {
                for (const k in obj) {
                    result += `<th>${k}</th>`
                }
            } else {
                for (const i in visible) {
                    result += `<th>${visible[i]}</th>`
                }
            }
            result += "</tr>"
            return result
        },
        tbody_html: function (obj_list) {
            visible = tb.config.visible_col
            hidden = tb.config.hidden_col
            extra_row_elems = tb.config.extra_row_elems
            html = ""
            let row_id = 0
            let uid = uid_generator.getId()
            for (let i in obj_list) {
                let obj = obj_list[i]
                let col_len = visible.length
                let row_html = `<tr class="clickable-row"><td>${(parseInt(i) + 1).toString()}</td>`
                if (visible.length == 0 && hidden.length == 0) {
                    for (const k in obj) {
                        row_html += `<td class="${k}">${tb.render_null(obj[k])}</td>`
                    }
                } else {
                    for (let i in visible) {
                        if (visible[i] == "") row_html += `<td></td>`
                        else row_html += `<td class="${visible[i]}">${tb.render_null(obj[visible[i]])}</td>`
                    }
                    for (let i in hidden) {
                        row_html += `<input type="hidden" class="${hidden[i]}" value="${tb.render_null(obj[hidden[i]])}">`
                    }
                }
                // 每行按钮等额外组件
                row_html += tb.extra_col_elems_html
                // 多加一行 accordion 插件
                if (extra_row_elems) { row_html += `<td><button class="accordion-button collapsed" data-bs-toggle="collapse" data-bs-target="#r${uid}_${row_id}"></button></td>` }
                row_html += '</tr>'
                // 多加一行 accordion 插件
                if (extra_row_elems) { row_html += `<tr class="collapse accordion-collapse" id="r${uid}_${row_id}"><td colspan=${col_len + 2}><table class="table table-striped table-sm"></table></td>${extra_row_elems}</tr>` }
                html += row_html
                row_id += 1
            }
            return html
        },
        render_null: function (value) {
            return value == null ? "" : value;
        },
        renderPager: function () {
            if (tb.data) {
                tb.totalPage.text(tb.total_page)
                tb.totalItems.text(tb.total)
                tb.pageNum.val(tb.curr_page)
                if (tb.total_page > 1) {
                    tb.pager.show()
                } else {
                    tb.pager.hide()
                }
            }
        },
        changePage: function () {
            action = $(this).attr("aria-label")
            currPageNum = parseInt(tb.pageNum.val())
            if (action == "Previous") {
                currPageNum -= 1
            }
            else if (action == "Next") {
                currPageNum += 1
            }
            if (currPageNum <= 0) currPageNum = 1
            else if (currPageNum > tb.total_page) currPageNum = tb.total_page
            if (currPageNum != tb.curr_page) {
                tb.curr_page = currPageNum
                tb.fetchData(tb.renderTable)
            }
        },
        get_extra_col_elems_html: function () {
            html = ""
            for (let i in tb.config.extra_col_elems) {
                elem = tb.config.extra_col_elems[i]
                html += `<td><${elem['tagName']} class="${elem['classname']}">${elem['text']}</${elem['tagName']}></td>`
            }
            return html
        },
        bind_button_event: function (index, ele) {
            tb.table.on('click', `.${ele["classname"]}`, function () {
                poitem_id = $(this).closest('tr').find("input._poitemid").val()
                poiteminfoid = $(this).closest('tr').find("input.id").val()
                console.log("poitem_id", poitem_id)
                console.log("poiteminfoid", poiteminfoid)
                if (ele["classname"] == 'more') {
                    em.update({
                        poitemid: poitem_id,
                        poiteminfoid: poiteminfoid
                    })
                    em.show()
                } else if (ele["classname"] == 'details') {
                    dm.update({
                        poitemid: poitem_id,
                        poiteminfoid: poiteminfoid
                    })
                    dm.show()
                }
            })
        },
        printConfig: function () {
            // console.log(tb.config)
        },

    }

    var em = {
        init: function (setting) {
            em.config = {
                id: "editModal",
                url_get: "/get_poitem_info",
                url_update: "/update_poitem_info",
                visible: ["transport", "priceBeforeNeg", "priceAfterNeg"],
                hidden: ["id", "_poitemid"],
                visible_col_type: [],
                poitemid: 0,
                poiteminfoid: 0
            };
            $.extend(em.config, setting)
            em.setup()
        },
        update: function (setting) {
            if (!em.config) em.init(setting)
            else {
                $.extend(em.config, setting)
                em.updateData()
                em.fetchData(em.renderForm)
            }
        },
        setup: function () {
            // DOM
            em.modal = $(`#${em.config.id}`)
            em.form = $(`#${em.config.id} form.edit-form`).eq(0)
            em.hiddenDiv = $(`#${em.config.id} div.hidden-field`).eq(0)
            em.saveBtn = $(`#${em.config.id} button.save-form`).eq(0)
            em.title = $(`#${em.config.id} div.modal-header h5.modal-title`).eq(0)
            em.message = $(`#${em.config.id} div.message`).eq(0)
            // var
            em.updateData()

            em.fetchData(em.renderForm)
            em.saveBtn.click(em.saveForm)
        },
        updateData: function () {
            em.poitemid = em.config.poitemid
            em.poiteminfoid = em.config.poiteminfoid
        },
        show: function () {
            em.modal.modal('show')
        },
        fetchData: function (callback) {
            params = { "poitem_id": em.poitemid }
            $.getJSON(em.config.url_get, params)
                .done(callback)
                .fail()
        },
        renderForm: function (data) {
            em.clearModal()
            if (!data) { em.data = null }
            else {
                if ($.isPlainObject(data.data)) {
                    em.data = data.data
                }
                else if ($.isArray(data.data)) {
                    em.data = data.data.length == 0 ? null : data.data[0]
                }
            }
            // console.log("renderForm", em.data)
            form_html = ""
            for (let i in em.config.visible) {
                let field = em.config.visible[i]
                temp =
                    `<div class="row mb-3">
                    <label for="m_${field}" class="col-sm-3 col-form-label">${field}</label>
                    <span for="m_${field}" class="col-sm-4 col-form-label">${em.data == null ? "" : (em.data[field] == null ? "" : em.data[field])}</span>
                    <div class="col-sm-5 col-form">
                        <input type="text" class="form-control" id="m_${field}" name="${field}"/>
                    </div>
                </div>`
                form_html += temp
            }
            em.form.html(form_html)

            hidden_html = ""
            for (let i in em.config.hidden) {
                let field = em.config.hidden[i]
                temp = `<input type=hidden class=${field} value="${em.data == null ? "" : (em.data[field] == null ? "" : em.data[field])}/>"`
                hidden_html += temp
            }
            em.hiddenDiv.html(hidden_html)
        },
        clearModal: function () {
            em.form.html("")
            em.hiddenDiv.html("")
            em.title.text("")
            em.message.text("")
            em.message.attr("class", "message alert")
        },
        saveForm: function () {
            params = {
                "id": em.poiteminfoid,
                "poitemid": em.poitemid,
            }
            em.form.find("input").each(function () {
                value = $(this).val().trim()
                if (value != "") {
                    params[this.name] = value
                }
            })
            let posting = $.post(em.config.url_update, params)
            posting.done(function (data) {
                em.message.attr('class', "message alert")
                em.message.text("")

                if (data.success) {
                    em.renderForm(data)
                    em.message.attr('class', "message alert alert-success")
                } else {
                    em.message.attr('class', "message alert alert-danger")
                }
                em.message.text(data.message)

            }).fail(function () {
                em.message.attr('class', "message alert alert-warning")
                em.message.text("network error")
            })
        }
    }

    // var dm_tb = Object.assign({}, tb)
    // $.extend(dm_tb, {
    //     getParams: function () {
    //         return { po_item_info_id: this.poiteminfoid }
    //     },
    //     bind_button_event: null,

    // })
    var dm_tb = Object.create(tb)


    var dm = {
        init: function (settings) {
            this.config = {
                id: "detailModal",
                poiteminfoid: null,
                poitemid: null,
                url: "/add_poiteminfo_detail",
                tableid: "dmtb"
            }
            $.extend(this.config, settings)
            this.setup()
        },
        setup: function () {
            //DOM 
            this.modal = $(`#${this.config.id}`)
            this.contentInput = this.modal.find('textarea.content').eq(0)
            this.addBtn = this.modal.find('button.add-detail').eq(0)

            console.log("this.config.poiteminfoid", this.config.poiteminfoid)

            $.extend(dm_tb, {
                getParams: function () {
                    return { po_item_info_id: this.poiteminfoid }
                },
            })
            this.table =
                dm_tb.init({
                    id: this.config.tableid,
                    visible_col: ["content", "username", "created"],
                    hidden_col: ["id"],
                    poiteminfoid: this.config.poiteminfoid,
                    url: "/get_po_item_info_details",
                    limit: 5,
                    params: { po_item_info_id: this.config.poiteminfoid }
                })

            console.log("this.table.getParams", this.table.getParams())

            //var
            this.poiteminfoid = this.config.poiteminfoid
            this.poitemid = this.config.poitemid

            this.table.fetchData(this.table.renderTable)
            this.addBtn.click(this.onBtnClick)
        },
        update: function (settings) {
            if (!this.config) this.init(settings)
            else {
                $.extend(this.config, settings)
                this.updateData()
                this.table.fetchData(this.table.renderTable)
            }
        },
        updateData: function () {
            this.poiteminfoid = this.config.poiteminfoid
            this.poitemid = this.config.poitemid
        },
        onBtnClick: function () {

        },
        show: function () {
            this.modal.modal('show')
        }
    }



    $(function () {
        // console.log(dm_tb)

        var myTb = tb.init({
            id: "tb1",
            url: "/get_poitem_info",
            extra_col_elems: [{ "tagName": "button", "classname": "more", "text": "more" }, { "tagName": "button", "classname": "details", "text": "details" }],
            visible_col: ["_poitemid", "id", "description"],
            hidden_col: ["_poitemid", "id"],
        })

    })
</script>
{% endblock %}